# K-means II

## 初始化

K-means++的超采样因子$l=\Omega(k)$，而K-means II的超采样因子为$l=\Theta(k)$。

- 从均匀分布中随机取得一个初始中心放入集合${\bf C}$，${\bf C}$为聚类中心的集合。
- 计算当前${\bf C}$与全集${\bf X}$之间的代价$\psi$。$\psi=\phi_{\bf X}({\bf C})=\sum_{x\in{\bf X}}d^2(x,{\bf C})=\sum_{x\in{\bf X}}\min_{i=1,...,k}||x-c_i||^2$。
- ${\bf for}\;O(\log\psi)\;times\;{\bf do}$
  - 在全集${\bf X}$中取每个点计算$p_x=\frac{l\cdot d^2(x,{\bf C})}{\phi_{\bf X}({\bf C})}$；
  - 取$p_x$最大的$l$个点并入${\bf C}$；
- ${\bf end\;for}$
- 计算${\bf C}$中每个向量与全集${\bf X}$捕获的向量个数$\omega_x$。
- 使用k-means++对${\bf C}$进行$k$个中心的聚类，从均匀分布随机取一个中心放入${\bf C}_f$。
  - ${\bf while}\;|{\bf C}_f|<k\;{\bf do}$
    - 计算$c\in{\bf C}$中的每个概率，计算概率时分子乘上权重$p_c=\frac{\omega_cd^2(c,{\bf C}_f)}{\phi_{\bf C}({\bf C}_f)}$；
    - 取$p_c$最大的点并入${\bf C}_f$；
  - ${\bf end\;while}$

## 迭代

- 计算全集${\bf X}$中的每个向量分别与${\bf C}_f$中的每个聚类中心的距离，判定向量归属。
- ${\bf C}_n={\bf C}_f$。
- ${\bf do}$
  - ${\bf C}_o={\bf C}_n$；
  - 计算每个子类的element-wise均值向量$c_{ni}$，组成新的聚类中心集合${\bf C}_n$；
- ${\bf while}\;||c_{oi}-c_{ni}||>\epsilon,c_{oi}\in{\bf C}_o,c_{ni}\in{\bf C}_n$，$\epsilon$是聚类中心变化的阈值。

# PQ

## 建库

划分子向量，划分为6组16维的子向量。对于每个组：

- 进行k-means II，得到聚类中心，落盘；
- 计算原始向量与聚类中心的归属关系，记录每个向量所属的聚类中心索引，作为码本落盘；

## 查询

将查询向量划分为6组16维子向量。对于每个子向量：

- 计算与该子组中的所以聚类中心的距离，生成$k$维的距离表；

将所有子组的距离表拼接为$6\times k$维的距离表；

对于每个原始向量，取码本中的每个聚类中心索引对应的距离表中的距离，各子段距离相加即为该原始向量与查询向量之间的非对称距离。

将这些距离排序，取top k。

# 超参数

- K-means II超采样因子$l$；
- 初始化迭代次数；
- 迭代终止条件阈值$\epsilon$；
- 聚类中心数量$k$；
